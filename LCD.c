// Дисплей от нокии 3310 сделан на чипсете PCD8544
// Работает по SPI
// На дисплей заводятся контакты 
// RES - сброс PE13
// SCE - чип селект PE15
// D/C - режим PB11
// SDin - линия PB15
// SCL -  Тактирование PB13 

#include "stm32f4xx.h"
#include "stm32f4xx_gpio.h"
#include "stm32f4xx_rcc.h"
#include "LCD.h"


const uint8_t lcd_nokia1100_decode[] =
{ '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E',
		'F' };


static __IO uint32_t TimingDelay;

//Задержка в милисекундах
void Delay(__IO uint32_t nCount);

void TimingDelay_Decrement(void)
{
  if (TimingDelay != 0x00)
  { 
    TimingDelay--;
  }
}


void SysTick_Handler(void)
{
  TimingDelay_Decrement();
}


void Delay(__IO uint32_t nTime)
{ 
  TimingDelay = nTime;

  while(TimingDelay != 0);
}


void lcd3310_init_pins()
{
  
RCC_AHB1PeriphClockCmd(sck_port_clock | sdin_port_clock | dc_port_clock | sce_port_clock | res_port_clock, ENABLE);

sck_port->BSRRH = sck_pin;
sdin_port->BSRRH = sdin_pin;
dc_port->BSRRH = dc_pin;
sce_port->BSRRL = sce_pin;
res_port->BSRRH = res_pin;

GPIO_InitTypeDef gpio;
GPIO_StructInit(&gpio);
gpio.GPIO_Mode = GPIO_Mode_OUT;
gpio.GPIO_OType = GPIO_OType_PP;
gpio.GPIO_Pin = sck_pin;
gpio.GPIO_Speed = GPIO_Speed_2MHz;
GPIO_Init(sck_port, &gpio);

gpio.GPIO_Pin = sdin_pin;
GPIO_Init(sdin_port, &gpio);

gpio.GPIO_Pin = dc_pin;
GPIO_Init(dc_port, &gpio);

gpio.GPIO_Pin = sce_pin;
GPIO_Init(sce_port, &gpio);

gpio.GPIO_Pin = res_pin;
GPIO_Init(res_port, &gpio);
}

void lcd3310_init()
{
sce_down;
Delay(1);
res_down;
Delay(10);
res_up;
Delay(1);
sce_up;

Delay(10);

//Function set 00100PVH управление питанием, способ ввода, выбор расширенных инструкций
lcd3310_send_byte(0x21, DC_CMD); // ; кристалл включен, адресация построчная, набор команд расширенный

//Set Vop 1VVVVVVV включить напряжение питания дисплея
lcd3310_send_byte(0x21, DC_CMD);

// Temperature Control
//	 000001TT установить температурный коэффициент
lcd3310_send_byte(0x6, DC_CMD); //TT = 01

//Bias System 00010BBB выбрать систему питания
lcd3310_send_byte(0x13, DC_CMD); //BBB = 011


lcd3310_send_byte(0x20, DC_CMD); // переводим дисплей на обычный набор команд
lcd3310_send_byte(0xC, DC_CMD); //1D0E нормальный режим отображения

}


void lcd3310_send_byte(uint8_t byte, uint8_t dc)
{
if (dc == DC_DATA)
dc_up;
else
dc_down;

Delay(1);

sce_down; //chip select active low

uint8_t i = 0;
uint8_t mask = 0x80;
for (i = 0; i < 8; i++)
{
Delay(1);
sck_down;
Delay(1);

if ((byte & mask) == 0x80)
sdin_up;
else
sdin_down;

Delay(1);

sck_up;
byte <<= 1;
}

Delay(1);
sce_up; //отключаем chip select
Delay(1);
sck_down; // опускаем тактовую ножку, чтобы зря не болталась;
}

const uint8_t lcd_nokia1100_font_5x8[96][5] =
{
	{ 0x00, 0x00, 0x00, 0x00, 0x00 },// (space)
	{ 0x00, 0x00, 0x5F, 0x00, 0x00 },// !
	{ 0x00, 0x07, 0x00, 0x07, 0x00 },// "
	{ 0x14, 0x7F, 0x14, 0x7F, 0x14 },// #
	{ 0x24, 0x2A, 0x7F, 0x2A, 0x12 },// $
	{ 0x23, 0x13, 0x08, 0x64, 0x62 },// %
	{ 0x36, 0x49, 0x55, 0x22, 0x50 },// &
	{ 0x00, 0x05, 0x03, 0x00, 0x00 },// '
	{ 0x00, 0x1C, 0x22, 0x41, 0x00 },// (
	{ 0x00, 0x41, 0x22, 0x1C, 0x00 },// )
	{ 0x08, 0x2A, 0x1C, 0x2A, 0x08 },// *
	{ 0x08, 0x08, 0x3E, 0x08, 0x08 },// +
	{ 0x00, 0x50, 0x30, 0x00, 0x00 },// ,
	{ 0x08, 0x08, 0x08, 0x08, 0x08 },// -
	{ 0x00, 0x30, 0x30, 0x00, 0x00 },// .
	{ 0x20, 0x10, 0x08, 0x04, 0x02 },// /
	{ 0x3E, 0x51, 0x49, 0x45, 0x3E },// 0
	{ 0x00, 0x42, 0x7F, 0x40, 0x00 },// 1
	{ 0x42, 0x61, 0x51, 0x49, 0x46 },// 2
	{ 0x21, 0x41, 0x45, 0x4B, 0x31 },// 3
	{ 0x18, 0x14, 0x12, 0x7F, 0x10 },// 4
	{ 0x27, 0x45, 0x45, 0x45, 0x39 },// 5
	{ 0x3C, 0x4A, 0x49, 0x49, 0x30 },// 6
	{ 0x01, 0x71, 0x09, 0x05, 0x03 },// 7
	{ 0x36, 0x49, 0x49, 0x49, 0x36 },// 8
	{ 0x06, 0x49, 0x49, 0x29, 0x1E },// 9
	{ 0x00, 0x36, 0x36, 0x00, 0x00 },// :
	{ 0x00, 0x56, 0x36, 0x00, 0x00 },// ;
	{ 0x00, 0x08, 0x14, 0x22, 0x41 },// <
	{ 0x14, 0x14, 0x14, 0x14, 0x14 },// =
	{ 0x41, 0x22, 0x14, 0x08, 0x00 },// >
	{ 0x02, 0x01, 0x51, 0x09, 0x06 },// ?
	{ 0x32, 0x49, 0x79, 0x41, 0x3E },// @
	{ 0x7E, 0x11, 0x11, 0x11, 0x7E },// A
	{ 0x7F, 0x49, 0x49, 0x49, 0x36 },// B
	{ 0x3E, 0x41, 0x41, 0x41, 0x22 },// C
	{ 0x7F, 0x41, 0x41, 0x22, 0x1C },// D
	{ 0x7F, 0x49, 0x49, 0x49, 0x41 },// E
	{ 0x7F, 0x09, 0x09, 0x01, 0x01 },// F
	{ 0x3E, 0x41, 0x41, 0x51, 0x32 },// G
	{ 0x7F, 0x08, 0x08, 0x08, 0x7F },// H
	{ 0x00, 0x41, 0x7F, 0x41, 0x00 },// I
	{ 0x20, 0x40, 0x41, 0x3F, 0x01 },// J
	{ 0x7F, 0x08, 0x14, 0x22, 0x41 },// K
	{ 0x7F, 0x40, 0x40, 0x40, 0x40 },// L
	{ 0x7F, 0x02, 0x04, 0x02, 0x7F },// M
	{ 0x7F, 0x04, 0x08, 0x10, 0x7F },// N
	{ 0x3E, 0x41, 0x41, 0x41, 0x3E },// O
	{ 0x7F, 0x09, 0x09, 0x09, 0x06 },// P
	{ 0x3E, 0x41, 0x51, 0x21, 0x5E },// Q
	{ 0x7F, 0x09, 0x19, 0x29, 0x46 },// R
	{ 0x46, 0x49, 0x49, 0x49, 0x31 },// S
	{ 0x01, 0x01, 0x7F, 0x01, 0x01 },// T
	{ 0x3F, 0x40, 0x40, 0x40, 0x3F },// U
	{ 0x1F, 0x20, 0x40, 0x20, 0x1F },// V
	{ 0x7F, 0x20, 0x18, 0x20, 0x7F },// W
	{ 0x63, 0x14, 0x08, 0x14, 0x63 },// X
	{ 0x03, 0x04, 0x78, 0x04, 0x03 },// Y
	{ 0x61, 0x51, 0x49, 0x45, 0x43 },// Z
	{ 0x00, 0x00, 0x7F, 0x41, 0x41 },// [
	{ 0x02, 0x04, 0x08, 0x10, 0x20 },// "\"
	{ 0x41, 0x41, 0x7F, 0x00, 0x00 },// ]
	{ 0x04, 0x02, 0x01, 0x02, 0x04 },// ^
	{ 0x40, 0x40, 0x40, 0x40, 0x40 },// _
	{ 0x00, 0x01, 0x02, 0x04, 0x00 },// `
	{ 0x20, 0x54, 0x54, 0x54, 0x78 },// a
	{ 0x7F, 0x48, 0x44, 0x44, 0x38 },// b
	{ 0x38, 0x44, 0x44, 0x44, 0x20 },// c
	{ 0x38, 0x44, 0x44, 0x48, 0x7F },// d
	{ 0x38, 0x54, 0x54, 0x54, 0x18 },// e
	{ 0x08, 0x7E, 0x09, 0x01, 0x02 },// f
	{ 0x08, 0x14, 0x54, 0x54, 0x3C },// g
	{ 0x7F, 0x08, 0x04, 0x04, 0x78 },// h
	{ 0x00, 0x44, 0x7D, 0x40, 0x00 },// i
	{ 0x20, 0x40, 0x44, 0x3D, 0x00 },// j
	{ 0x00, 0x7F, 0x10, 0x28, 0x44 },// k
	{ 0x00, 0x41, 0x7F, 0x40, 0x00 },// l
	{ 0x7C, 0x04, 0x18, 0x04, 0x78 },// m
	{ 0x7C, 0x08, 0x04, 0x04, 0x78 },// n
	{ 0x38, 0x44, 0x44, 0x44, 0x38 },// o
	{ 0x7C, 0x14, 0x14, 0x14, 0x08 },// p
	{ 0x08, 0x14, 0x14, 0x18, 0x7C },// q
	{ 0x7C, 0x08, 0x04, 0x04, 0x08 },// r
	{ 0x48, 0x54, 0x54, 0x54, 0x20 },// s
	{ 0x04, 0x3F, 0x44, 0x40, 0x20 },// t
	{ 0x3C, 0x40, 0x40, 0x20, 0x7C },// u
	{ 0x1C, 0x20, 0x40, 0x20, 0x1C },// v
	{ 0x3C, 0x40, 0x30, 0x40, 0x3C },// w
	{ 0x44, 0x28, 0x10, 0x28, 0x44 },// x
	{ 0x0C, 0x50, 0x50, 0x50, 0x3C },// y
	{ 0x44, 0x64, 0x54, 0x4C, 0x44 },// z
	{ 0x00, 0x08, 0x36, 0x41, 0x00 },// {
	{ 0x00, 0x00, 0x7F, 0x00, 0x00 },// |
	{ 0x00, 0x41, 0x36, 0x08, 0x00 },// }
	{ 0x08, 0x08, 0x2A, 0x1C, 0x08 },// ->
	{ 0x08, 0x1C, 0x2A, 0x08, 0x08 } // <-
};




void lcd3310_print_char(uint8_t simbol)
{
	uint8_t line_number;

	for (line_number = 0; line_number < 5; line_number++)
	{
		lcd3310_send_byte(
				lcd_nokia1100_font_5x8[simbol - 32][line_number],DC_DATA);
	}
        lcd3310_send_byte(0x00,DC_DATA);
}




void lcd3310_clear(void)
{
	uint8_t i;

	lcd3310_send_byte(LCD_NOKIA1100_SET_START_ROW_ADDRESS_6BITS,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_SET_X_ADDRESS_UPPER_3BITS | 0x0,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_SET_X_ADDRESS_LOWER_4BITS | 0x0,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_SET_Y_ADDRESS | 0x0,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_DIPLAY_OFF,DC_CMD);

	for (i = 0; i < 216; i++)
	{
		lcd3310_send_byte(0x00,DC_DATA);
		lcd3310_send_byte(0x00,DC_DATA);
		lcd3310_send_byte(0x00,DC_DATA);
		lcd3310_send_byte(0x00,DC_DATA);
	}

	lcd3310_send_byte(LCD_NOKIA1100_DIPLAY_ON,DC_CMD);
        lcd3310_send_byte(LCD_NOKIA1100_SET_X_ADDRESS_UPPER_3BITS | 0x0,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_SET_X_ADDRESS_LOWER_4BITS | 0x0,DC_CMD);
	lcd3310_send_byte(LCD_NOKIA1100_SET_Y_ADDRESS | 0x0,DC_CMD);
}



/* Функция рисует точку с координатами x,y
// максимальные значения функции 83х47
// в случае ошибочных координат возвращает 0 */

uint8_t lsd3310_point (uint8_t x,uint8_t y)

{  
  if (x>83 || y>47) return 0;
  uint8_t temp=y/8;
  lcd3310_send_byte(0x40 | (y/8),DC_CMD);
  lcd3310_send_byte(0x80 | x,DC_CMD);
  lcd3310_send_byte(0x01<<(y-temp*8),DC_DATA);
  return 1;
}




void lcd3310_print_hex(uint32_t data)
{ 
        lcd3310_print_char(lcd_nokia1100_decode[(data >> 8) & 0x0F]);  
	lcd3310_print_char(lcd_nokia1100_decode[(data >> 4) & 0x0F]);
	lcd3310_print_char(lcd_nokia1100_decode[data & 0x0F]);
}

/*
//-----------------------------------------------------------------------------
void lcd_nokia1100_print_string(uint8_t * string)
{
	lcd_nokia1100_write_command(LCD_NOKIA1100_DIPLAY_OFF);

	while (*string)
	{
		lcd_nokia1100_print_char(*string++);
	}

	lcd_nokia1100_write_command(LCD_NOKIA1100_DIPLAY_ON);
}

void lcd_nokia1100_print_dec_xxx(uint8_t data)
{
	lcd_nokia1100_print_char(lcd_nokia1100_decode[(data / 100) & 0x0F]);
	lcd_nokia1100_print_char(lcd_nokia1100_decode[((data % 100) / 10) & 0x0F]);
	lcd_nokia1100_print_char(lcd_nokia1100_decode[((data % 100) % 10) & 0x0F]);
}

//-----------------------------------------------------------------------------
void lcd_nokia1100_print_dec_xx(uint8_t data)
{
	lcd_nokia1100_print_char(lcd_nokia1100_decode[((data % 100) / 10) & 0x0F]);
	lcd_nokia1100_print_char(lcd_nokia1100_decode[((data % 100) % 10) & 0x0F]);
}*/